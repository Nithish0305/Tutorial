{% extends 'journal/base.html' %}

{% block content %}
<!-- Loading overlay -->
<div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 9999; display: none; justify-content: center; align-items: center;">
    <div style="background-color: white; padding: 20px; border-radius: 10px; text-align: center;">
        <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        <p style="margin-top: 10px;">Processing your mood...</p>
    </div>
</div>

<!-- Success message -->
<div id="successMessage" style="display: none; position: fixed; top: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 15px; border-radius: 5px; z-index: 9999;">
    Your mood has been saved successfully!
</div>

<div class="mood-container">
    <div id="particles-js"></div>
    
    <div class="mood-form">
        <h2>How are you feeling today?</h2>
        <form id="moodForm">
            <div class="form-group">
                <label for="username">Your Name:</label>
                <input type="text" id="username" name="username" required>
            </div>
            
            <div class="form-group">
                <label>Select Your Mood:</label>
                <div class="mood-grid">
                    {% for mood in moods %}
                    <div class="mood-item" data-mood="{{ mood|lower }}">
                        <div class="mood-icon">
                            {% if mood == 'Happy' %}
                                <i class="far fa-smile"></i>
                            {% elif mood == 'Sad' %}
                                <i class="far fa-sad-tear"></i>
                            {% elif mood == 'Relax' %}
                                <i class="far fa-meh"></i>
                            {% elif mood == 'Energetic' %}
                                <i class="fas fa-bolt"></i>
                            {% elif mood == 'Romantic' %}
                                <i class="fas fa-heart"></i>
                            {% elif mood == 'Angry' %}
                                <i class="far fa-angry"></i>
                            {% elif mood == 'Chill' %}
                                <i class="far fa-snowflake"></i>
                            {% elif mood == 'Motivated' %}
                                <i class="fas fa-fire"></i>
                            {% elif mood == 'Melancholy' %}
                                <i class="fas fa-cloud-rain"></i>
                            {% elif mood == 'Excited' %}
                                <i class="fas fa-star"></i>
                            {% endif %}
                        </div>
                        <span>{{ mood }}</span>
                    </div>
                    {% endfor %}
                </div>
                <input type="hidden" id="selectedMood" name="mood" required>
            </div>
            
            <button type="submit" class="btn">Submit</button>
        </form>
    </div>
    
    <div class="mood-result" style="display: none;">
        <div class="result-content">
            <h2>Your Mood: <span id="resultMood"></span></h2>
            <div class="quote-box">
                <i class="fas fa-quote-left"></i>
                <p id="resultQuote"></p>
                <i class="fas fa-quote-right"></i>
            </div>
            
            <div class="music-player">
                <h3>Mood Music</h3>
                <audio id="moodAudio" controls></audio>
            </div>
            
            <button id="newMoodBtn" class="btn">New Mood</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize particles.js
    function initParticles(mood) {
        // Ensure loading overlay is hidden on page load
        $('#loadingOverlay').hide();
        
        let particleConfig = {
            particles: {
                number: {
                    value: 80,
                    density: {
                        enable: true,
                        value_area: 800
                    }
                },
                color: {
                    value: "#ffffff"
                },
                shape: {
                    type: "circle",
                    stroke: {
                        width: 0,
                        color: "#000000"
                    },
                    polygon: {
                        nb_sides: 5
                    },
                    image: {
                        src: "img/github.svg",
                        width: 100,
                        height: 100
                    }
                },
                opacity: {
                    value: 0.5,
                    random: false,
                },
                size: {
                    value: 3,
                    random: true,
                },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: "#ffffff",
                    opacity: 0.4,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 2,
                    direction: "none",
                    random: false,
                    straight: false,
                    out_mode: "out",
                    bounce: false,
                }
            },
            interactivity: {
                detect_on: "canvas",
                events: {
                    onhover: {
                        enable: true,
                        mode: "grab"
                    },
                    onclick: {
                        enable: true,
                        mode: "push"
                    },
                    resize: true
                },
                modes: {
                    grab: {
                        distance: 140,
                        line_linked: {
                            opacity: 1
                        }
                    },
                    push: {
                        particles_nb: 4
                    }
                }
            },
            retina_detect: true
        };
        
        // Customize particles based on mood
        if (mood) {
            switch(mood.toLowerCase()) {
                case 'happy':
                    particleConfig.particles.color.value = ["#FFD700", "#FFA500", "#FF6347"];
                    particleConfig.particles.line_linked.color = "#FFD700";
                    particleConfig.particles.move.speed = 4;
                    particleConfig.particles.shape.type = "circle";
                    particleConfig.particles.size.value = 6;
                    particleConfig.particles.size.random = true;
                    particleConfig.particles.number.value = 90;
                    break;
                case 'sad':
                    particleConfig.particles.color.value = "#6495ED";
                    particleConfig.particles.line_linked.color = "#6495ED";
                    particleConfig.particles.move.speed = 1.5;
                    break;
                case 'relax':
                    particleConfig.particles.color.value = "#90EE90";
                    particleConfig.particles.line_linked.color = "#90EE90";
                    particleConfig.particles.move.speed = 1;
                    break;
                case 'energetic':
                    particleConfig.particles.color.value = "#FF4500";
                    particleConfig.particles.line_linked.color = "#FF4500";
                    particleConfig.particles.move.speed = 6;
                    particleConfig.particles.number.value = 120;
                    break;
                case 'romantic':
                    particleConfig.particles.color.value = ["#FF69B4", "#FF1493", "#DC143C"];
                    particleConfig.particles.line_linked.color = "#FF69B4";
                    particleConfig.particles.shape.type = "star";
                    particleConfig.particles.shape.star.nb_sides = 5;
                    particleConfig.particles.size.value = 8;
                    particleConfig.particles.size.random = true;
                    particleConfig.particles.opacity.value = 0.8;
                    particleConfig.particles.move.speed = 2;
                    particleConfig.particles.number.value = 60;
                    break;
                case 'angry':
                    particleConfig.particles.color.value = "#FF0000";
                    particleConfig.particles.line_linked.color = "#FF0000";
                    particleConfig.particles.move.speed = 8;
                    particleConfig.particles.shape.type = "triangle";
                    particleConfig.particles.size.value = 4;
                    break;
                case 'chill':
                    particleConfig.particles.color.value = "#00CED1";
                    particleConfig.particles.line_linked.color = "#00CED1";
                    particleConfig.particles.move.speed = 1;
                    particleConfig.particles.shape.type = "circle";
                    particleConfig.particles.opacity.value = 0.3;
                    break;
                case 'motivated':
                    particleConfig.particles.color.value = "#FFA500";
                    particleConfig.particles.line_linked.color = "#FFA500";
                    particleConfig.particles.move.speed = 5;
                    particleConfig.particles.shape.type = "polygon";
                    particleConfig.particles.shape.polygon.nb_sides = 5;
                    break;
                case 'melancholy':
                    particleConfig.particles.color.value = "#9370DB";
                    particleConfig.particles.line_linked.color = "#9370DB";
                    particleConfig.particles.move.speed = 1.5;
                    particleConfig.particles.move.direction = "bottom";
                    particleConfig.particles.opacity.value = 0.6;
                    break;
                case 'excited':
                    particleConfig.particles.color.value = ["#FF1493", "#FF4500", "#FFD700"];
                    particleConfig.particles.line_linked.color = "#FF1493";
                    particleConfig.particles.move.speed = 7;
                    particleConfig.particles.number.value = 120;
                    particleConfig.particles.shape.type = "star";
                    particleConfig.particles.shape.star.nb_sides = 5;
                    particleConfig.particles.size.value = 6;
                    particleConfig.particles.size.random = true;
                    break;
            }
        }
        
        particlesJS('particles-js', particleConfig);
    }
    
    // Set background gradient based on mood
    function setMoodBackground(mood) {
        let gradientColors = {};
        
        switch(mood.toLowerCase()) {
            case 'happy':
                gradientColors = {
                    start: '#FFD700',
                    end: '#FFA500'
                };
                break;
            case 'sad':
                gradientColors = {
                    start: '#6495ED',
                    end: '#4169E1'
                };
                break;
            case 'relax':
                gradientColors = {
                    start: '#90EE90',
                    end: '#3CB371'
                };
                break;
            case 'energetic':
                gradientColors = {
                    start: '#FF4500',
                    end: '#FF8C00'
                };
                break;
            case 'romantic':
                gradientColors = {
                    start: '#FF69B4',
                    end: '#DA70D6'
                };
                break;
            case 'angry':
                gradientColors = {
                    start: '#FF0000',
                    end: '#8B0000'
                };
                break;
            case 'chill':
                gradientColors = {
                    start: '#00CED1',
                    end: '#5F9EA0'
                };
                break;
            case 'motivated':
                gradientColors = {
                    start: '#FFA500',
                    end: '#FF6347'
                };
                break;
            case 'melancholy':
                gradientColors = {
                    start: '#9370DB',
                    end: '#483D8B'
                };
                break;
            case 'excited':
                gradientColors = {
                    start: '#FF1493',
                    end: '#FF69B4'
                };
                break;
            default:
                gradientColors = {
                    start: '#3498db',
                    end: '#2c3e50'
                };
        }
        
        document.body.style.background = `linear-gradient(135deg, ${gradientColors.start}, ${gradientColors.end})`;
    }
    
    // Initialize default particles
    $(document).ready(function() {
        // Ensure loading overlay is hidden on page load
        $('#loadingOverlay').hide();
        initParticles();
        
        // Mood selection with enhanced feedback
        $('.mood-item').click(function() {
            // Visual feedback - reset all items first
            $('.mood-item').removeClass('selected').css({
                'opacity': '0.6',
                'transform': 'scale(1)',
                'background-color': '',
                'box-shadow': ''
            });
            
            // Apply selected state to clicked item
            $(this).addClass('selected');
            
            // Set the hidden input value
            const selectedMood = $(this).data('mood');
            // Get the display text (capitalized version) for UI
            const displayMood = $(this).find('span').text();
            
            // Set the hidden input with the capitalized mood name
            $('#selectedMood').val(displayMood);
            
            // Show visual feedback to user
            const submitBtn = $('button[type="submit"]');
            submitBtn.text('Submit ' + displayMood + ' Mood');
            submitBtn.prop('disabled', false);
            submitBtn.addClass('btn-active');
            
            // Apply selected styling to current item
            $(this).css({
                'opacity': '1',
                'transform': 'scale(1.05)',
                'background-color': 'rgba(255, 107, 107, 0.9)',
                'box-shadow': '0 0 15px rgba(255, 107, 107, 0.7)'
            });
            
            // Flash effect for better visibility
            $(this).fadeOut(100).fadeIn(100);
            
            console.log('Selected mood (data):', selectedMood); // Debug log
            console.log('Display mood (text):', displayMood); // Debug log
            console.log('Hidden input value:', $('#selectedMood').val()); // Debug log to verify hidden input value
        });
        
        // Reset mood selection styles when clicking elsewhere
        $(document).on('click', function(e) {
            if(!$(e.target).closest('.mood-item').length && !$(e.target).closest('button[type="submit"]').length) {
                return; // Don't reset if clicking on a mood item or submit button
            }
        });
        
        // Initialize submit button state
        $('button[type="submit"]').prop('disabled', true).text('Select a Mood First');
        
        // Form submission
        $('#moodForm').submit(function(e) {
            e.preventDefault();
            
            const username = $('#username').val();
            const mood = $('#selectedMood').val();
            
            console.log('Form submission - Username:', username, 'Mood:', mood); // Debug log
            console.log('Hidden input value on submit:', $('#selectedMood').val()); // Additional debug log
            
            if (!username) {
                alert('Please enter your name');
                return;
            }
            
            if (!mood) {
                alert('Please select a mood');
                return;
            }
            
            // Show loading indicator and overlay
            $('#loadingOverlay').css({
                'display': 'flex',
                'opacity': 0
            }).animate({opacity: 1}, 300);
            $('button[type="submit"]').prop('disabled', true).text('Submitting...');
            
            // Submit form via AJAX
            console.log('Sending AJAX request with data:', { username, mood }); // Debug log
            $.ajax({
                url: '{% url "submit_mood" %}',
                type: 'POST',
                data: {
                    username: username,
                    mood: mood,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    console.log('Response received:', response); // Debug log
                    $('#loadingOverlay').animate({opacity: 0}, 300, function() {
                        $(this).css('display', 'none');
                    });
                    
                    if (response.status === 'success') {
                        // Update UI with response
                        $('#resultMood').text(response.mood);
                        
                        // Handle quote display
                        if (response.quote && response.quote.text) {
                            $('#resultQuote').text(response.quote.text);
                        } else if (response.quote) {
                            $('#resultQuote').text(response.quote);
                        }
                        
                        // Show success message
                        $('#successMessage').fadeIn(300).delay(3000).fadeOut(300);
                        
                        // Set audio source if available
                        if (response.song && response.song.url) {
                            $('#moodAudio').attr('src', response.song.url);
                        } else if (response.song_path) {
                            $('#moodAudio').attr('src', response.song_path);
                        }
                        
                        if ($('#moodAudio').attr('src')) {
                            $('#moodAudio')[0].load();
                        }
                        
                        // Update background and particles
                        setMoodBackground(response.mood);
                        initParticles(response.mood);
                        
                        // Show result and hide form
                        $('.mood-form').hide();
                        $('.mood-result').fadeIn();
                    } else {
                        // Show error message
                        alert(response.message || 'An error occurred. Please try again.');
                        // Reset submit button
                        $('button[type="submit"]').prop('disabled', false).text('Submit Mood');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', xhr.responseText, status, error); // Debug log
                    // Hide loading overlay
                    $('#loadingOverlay').animate({opacity: 0}, 300, function() {
                        $(this).css('display', 'none');
                    });
                    alert('An error occurred. Please try again.');
                    // Reset submit button
                    $('button[type="submit"]').prop('disabled', false).text('Submit Mood');
                }
            });
        });
        
        // New mood button
        $('#newMoodBtn').click(function() {
            // Reset form
            $('#moodForm')[0].reset();
            $('.mood-item').removeClass('selected');
            
            // Reset background and particles
            document.body.style.background = '';
            initParticles();
            
            // Show form and hide result
            $('.mood-result').hide();
            $('.mood-form').fadeIn();
        });
    });
</script>
{% endblock %}